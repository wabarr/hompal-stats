---
title: "Visualizing Data"
---


## I am opinionated when it comes to graphics in R.

I prefer to not to use the standard graphics facilities in R, which are rather kludgy and take lots of tweaking to make the graphs look great.  Instead, I prefer to use the `ggplot2` package.  You need to install this package using the standard package manager: Tools > Package Manager. Then you will load the package using the command `library(ggplot2)`.

`ggplot2` provides a convenient function called `qplot()` for making quick plots that don't require a lot of customization. 

## Basic Plotting

We will use a built in dataset called `diamonds`.  Lets take a look at the head (i.e. first few rows) of this dataset.

```{r}
library(ggplot2)
head(diamonds)
```


### Univariate plot

The simplest usage of `qplot()` is to provide a variable for the x axis, and a dataframe in which to look for this variable.  `qplot()` will attempt to guess the best `geom` (graphical geometric representation) with which to display the data. Here we plot a histogram of diamond weights. As we would expect....most diamonds are small, so the graph is skewed. 

```{r}
library(ggplot2)
qplot(x=carat, data=diamonds)
```

### Bivariate Plot

If we specify an additional variable for the y axis, then the default `geom` is a scatter of points. This time we will also specify a value for `main` which is the main title. 

```{r cache=TRUE}
qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price")
```

### Boxplot

Now lets plot clarity by carat. 

```{r cache=TRUE}
qplot(x=clarity, y=carat, data=diamonds)
```

We got points as the `geom`, but we can explicitly tell `qplot()` to use a different geom. 

```{r cache=TRUE}
qplot(x=clarity, y=carat, data=diamonds, geom="boxplot")
```

## Layers

The most common layer you will want to add is a line representing a linear regression. To do this, we start with the bivariate plot, then add a new layer. 

```{r cache=TRUE}
weight_by_price <- qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price")
weight_by_price + stat_smooth(method="lm")
```

Another common layer you will want to add is an annotation layer.  The `annotate()` function lets you do that.  

```{r cache=TRUE}
weight_by_price + annotate("text", x=2, y=25000, label="Here is a nice annotation, dear reader.")
```

### <span class="mega-octicon octicon-puzzle"></span> Challenge 

The relationship here is clearly not linear.  Recreate the plot in log space by computing the natural log of both variables. To save memory space do the log calculations inline, without saving the logged variables. 

## Color, Size, Shape, Fill

Sometimes we want to see the impact of other variables  variables by color coding points, or changing the shape or size of points in relation to another variable.  `qplot()` makes this very easy, and even automatically creates legends for us.  

```{r}
qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price", color=clarity)
qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price", shape=cut)
```

## Facets

When we have so many data points, it is hard to tell what is going on.  It would be nice to have a grid of sub-plots, so we can see the effect of these factors on the relationship between price and size. We can use the `facets` argument and tell it which factors we want to use, as in `facets=row_var~column_var`

```{r cache=TRUE}
qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price", facets=cut~clarity)
```

## Themes

There are a couple of shortcut theme functions that help you customize the look and feel of plots.  A very popular one is `theme_bw()` which gets rid of the default grey background. You can also specify a value for the base text size, to increase size for presentations, etc. All the text elements will scale intelligently. Also check out `theme_classic()`

```{r cache=TRUE}

qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price", color=clarity)+ theme_bw(20)

qplot(x=carat, y=price, data=diamonds, main="Diamond Weight by Price", color=clarity) + theme_classic(20)

```

## Default Themes

To make all of your plots share the same look and feel you can set the theme at the beginning of your script and the theme elements will be applied for all plots.  For instance:


```{r cache=TRUE}
theme_set(theme_bw(20))
qplot(price, data=diamonds)
qplot(depth, table, data=diamonds)
```

## The real ggplot()

Now I must reveal that you have been using a shortcut, and that you can't get the full benefit out of `ggplot2` with the `qplot()` shortcut.

`ggplot2` is based on the so-called "Grammar of Graphics", which is a terminology for describing how data is mapped to aesthetic properties to make informative graphics. Plots are comprised of the following

* background elements (shared by all layers in a plot)
    * coordinate system (usually Cartesian, so we don't often directly change this)
    * data - a dataframe which applies to all layers
    * scales - mapping of data values into plot values (either coordinates or aesthetic properties like color values)
    * facets (optional) - specification of subplots within a plot, mapped to a column in the dataframe
* layers which are ummm.....layered over the background
    * mapping - optional linking of data columns to aesthetic elements (color,shape,etc), that only apply to a particular layer
    * data - an optional additional dataframe used only in a particular layer
    * stat - a statistical transformation of rows in the dataframe (often this is the identity transformation)
    * geom - choice of how to graphically represent the stat
      
## The ggplot() workflow

*   invoke the `ggplot()` function to set background elements which will apply to all layers.
    * supply a base dataframe
    * use `aes()` to map dataframe columns to aesthetics. Things you can set include
        * `color`
        * `fill` (the color of polygons or boxplots)
        * `shape`
        * `size` 
        * `alpha` (i.e. transparency)
    *   Anything not getting mapped to a column (e.g. `color="blue"`) doesn't go inside a call to `aes()`
    *   Use `facet_grid()` or `facet_wrap()` to add faceting formula. 
*   Add layers to the plot, usually using one of the `geom_xxx()` functions.  For a full list of the possibilities try `??geom` The most common are
    *  `geom_point()`
    *  `geom_histogram()`
    *  `geom_bar()`
    *  `geom_path()`
    *  `geom_rect()`
    *  `geom_polygon()`
    *  `geom_abline()`
    *  `geom_text()`
    *  `geom_hline()` and `geom_vline()`
    *  **Note** you can map aesthetics specific to a layer by supplying the appropriate arguments to these functions
    *  **Warning** most of these functions will automatically inherit the aesthetics from the background.  If you want to override this behavior (e.g. to use a different dataframe), you can use the argument `inherit.aes=FALSE`
*   add an annotation layer `annotate()` to your plot (you can supply more complicated annotations by using a bonafide text layer using `geom_text()`)
*   Style the plot and tweak axes etc.
    * Themes are a useful shortcut 
    * There are some helper functions for tweaking plots
      * `labs(x="The X axis label", title="my nice little graph")`
      * `guides()` to tweak legend
      * `scale_x_continuous(limits=c(0,10))` to customize x scale
      * `scale_fill_xxx()` and `scale_color_xxx()` for customizing color choices    
*   Export the plot in a useful format using `ggsave()`
*   Submit for publication.

## A full example

First we set up the background: 

```{r cache=TRUE}
background <- ggplot(data = diamonds, aes(x = clarity, y=price))
```

<span class="mega-octicon octicon-question"></span> What happens when you type `background` in the interpreter at this point?

Now we add a boxplot layer:

```{r cache=TRUE, fig.width=14, units="in"}
with_boxplot <- background + geom_boxplot(aes(fill=cut))
with_boxplot
```

Finally, I style my plot with a theme, and make a couple of tweaks
```{r cache=TRUE, fig.width=14, units="in"}
with_boxplot + 
  theme_bw(20) + 
  labs(title="Price by Clarity") + 
  scale_y_continuous(limits=c(0,25000)) + 
  annotate("text", x=4.5, y=23000, label="There are lots of outliers, because people feel societal \npressure to pay a lot for engagement rings \n and or get duped by salespeople #speculation", size= 4)
```

